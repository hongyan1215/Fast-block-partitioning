# Fast Block Partitioning å°ˆæ¡ˆèªªæ˜

## ğŸ“Œ å°ˆæ¡ˆèƒŒæ™¯

åœ¨è¦–è¨Šç·¨ç¢¼ï¼ˆå¦‚ HEVCã€VVCï¼‰ä¸­ï¼Œ**å€å¡Šåˆ†å‰²æ±ºç­–ï¼ˆBlock Partitioning Decisionï¼‰** æ˜¯å½±éŸ¿ç·¨ç¢¼æ•ˆç‡çš„é—œéµæ­¥é©Ÿã€‚å‚³çµ±ç·¨ç¢¼å™¨ä½¿ç”¨ **RDOï¼ˆRate-Distortion Optimizationï¼‰** æš´åŠ›æœå°‹æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²æ–¹å¼ï¼Œé›–ç„¶æº–ç¢ºä½†æ¥µåº¦è€—æ™‚ã€‚

æœ¬å°ˆæ¡ˆå±•ç¤ºå¦‚ä½•ä½¿ç”¨ **æ©Ÿå™¨å­¸ç¿’ï¼ˆMLï¼‰** åŠ é€Ÿé€™å€‹æ±ºç­–éç¨‹ï¼Œå¯¦ç¾ **é€Ÿåº¦èˆ‡å“è³ªçš„æ¬Šè¡¡**ã€‚

---

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™

1. **æ¨¡æ“¬çœŸå¯¦ç·¨ç¢¼å™¨çš„ RDO è¨ˆç®—** â€” ä¸æ˜¯å‡çš„å»¶é²æ¨¡æ“¬
2. **è¨“ç·´ ML æ¨¡å‹é æ¸¬åˆ†å‰²æ±ºç­–** â€” Decision Tree äºŒå…ƒåˆ†é¡å™¨
3. **å¯¦ä½œ Confidence-based Hybrid æ©Ÿåˆ¶** â€” ä¿¡å¿ƒåº¦æ±ºå®šç­–ç•¥
4. **é‡åŒ– Speed vs Accuracy Trade-off** â€” Pareto Frontier åˆ†æ

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¼¸å…¥åœ–ç‰‡ (64Ã—64)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰¹å¾µè¨ˆç®— (Feature Extraction)             â”‚
â”‚  â€¢ Variance (è®Šç•°æ•¸) â€” å€å¡Šè¤‡é›œåº¦                            â”‚
â”‚  â€¢ Gradient_H (æ°´å¹³æ¢¯åº¦) â€” æ°´å¹³ç´‹ç†å¼·åº¦                      â”‚
â”‚  â€¢ Gradient_V (å‚ç›´æ¢¯åº¦) â€” å‚ç›´ç´‹ç†å¼·åº¦                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ML æ¨¡å‹é æ¸¬ (Binary Model)                â”‚
â”‚  è¼¸å‡º: {should_split: bool, confidence: 0.5~1.0}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
    confidence >= threshold?           confidence < threshold?
              â”‚                               â”‚
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½¿ç”¨ ML é æ¸¬çµæœ       â”‚     â”‚   å›é€€åˆ° RDO è¨ˆç®—        â”‚
â”‚   (å¿«é€Ÿè·¯å¾‘)             â”‚     â”‚   (ç²¾ç¢ºè·¯å¾‘)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸ·è¡Œåˆ†å‰²æ±ºç­–                              â”‚
â”‚  â€¢ Split â†’ éè¿´è™•ç† 4 å€‹å­å€å¡Š                               â”‚
â”‚  â€¢ No Split â†’ è©²å€å¡Šç‚ºæœ€çµ‚ç·¨ç¢¼å–®ä½                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ ¸å¿ƒæ¼”ç®—æ³•

### 1. RDO (Rate-Distortion Optimization)

```
RD Cost = Distortion + Î» Ã— Rate
```

| é …ç›® | è¨ˆç®—æ–¹å¼ | æ„ç¾© |
|------|----------|------|
| **Distortion** | SSD (Sum of Squared Differences) | å¤±çœŸç¨‹åº¦ |
| **Rate** | logâ‚‚(variance + 1) Ã— block_area | ç·¨ç¢¼ä½å…ƒæ•¸ä¼°è¨ˆ |
| **Î» (Lambda)** | 0.5 (å¯èª¿æ•´) | Rate-Distortion æ¬Šè¡¡å› å­ |

### 2. ML æ¨¡å‹ï¼ˆDecision Treeï¼‰

- **è¼¸å…¥ç‰¹å¾µ**: variance, grad_h, grad_v
- **è¼¸å‡º**: {should_split, confidence}
- **æ·±åº¦é™åˆ¶**: max_depth = 4ï¼ˆå„ªåŒ– Branch Predictionï¼‰

### 3. Hybrid ç­–ç•¥

```cpp
if (ml_prediction.confidence >= threshold) {
    // ML æœ‰ä¿¡å¿ƒ â†’ å¿«é€Ÿè·¯å¾‘
    return ml_prediction.should_split;
} else {
    // ML æ²’ä¿¡å¿ƒ â†’ å›é€€åˆ°ç²¾ç¢ºçš„ RDO
    return rdo_result.should_split;
}
```

---

## ğŸ“ˆ å¯¦é©—çµæœ

### Pareto Frontierï¼ˆé€Ÿåº¦ vs æº–ç¢ºåº¦æ¬Šè¡¡æ›²ç·šï¼‰

| Threshold | æ™‚é–“ (Î¼s) | åŠ é€Ÿæ¯” | æº–ç¢ºåº¦ | RDO é‹ç®—æ¬¡æ•¸ |
|-----------|-----------|--------|--------|--------------|
| 0.50 | 23.92 | **4.64x** | 15.34% | 0 |
| 0.60 | 23.29 | **4.76x** | 15.34% | 0 |
| 0.70 | 45.75 | **2.43x** | 61.96% | 100 |
| 0.80 | 44.92 | **2.47x** | 61.96% | 100 |
| 0.90 | 95.50 | **1.16x** | 85.28% | 275 |
| 0.95 | 142.25 | 0.78x | 95.09% | 345 |
| 1.00 | 151.29 | 0.73x | 95.09% | 345 |
| 1.01 | 156.63 | 0.71x | **100%** | 461 |

### é—œéµç™¼ç¾

| ä½¿ç”¨æƒ…å¢ƒ | å»ºè­° Threshold | åŠ é€Ÿæ¯” | æº–ç¢ºåº¦ |
|----------|----------------|--------|--------|
| è¿½æ±‚é€Ÿåº¦ | 0.5~0.6 | 4.7x | 15% |
| **å¹³è¡¡é¸æ“‡** | **0.7~0.8** | **2.4x** | **62%** |
| è¿½æ±‚å“è³ª | 0.9 | 1.16x | 85% |
| å®Œå…¨æº–ç¢º | >1.0 | 0.7x | 100% |

---

## ğŸ”§ æŠ€è¡“äº®é»

### 1. çœŸå¯¦çš„ RDO è¨ˆç®—
- ä½¿ç”¨ SSD è¨ˆç®—å¤±çœŸï¼Œä¸æ˜¯æ¨¡æ“¬å»¶é²
- Rate Estimation åŸºæ–¼è®Šç•°æ•¸
- ç¬¦åˆçœŸå¯¦ç·¨ç¢¼å™¨çš„æ±ºç­–é‚è¼¯

### 2. Python â†’ C++ è‡ªå‹•è½‰è­¯
```python
# Python è¨“ç·´
clf = DecisionTreeClassifier(max_depth=4)
clf.fit(X_train, y_train)

# è‡ªå‹•ç”Ÿæˆ C++ ç¨‹å¼ç¢¼
tree_to_cpp_with_confidence(clf, feature_names)
```

ç”Ÿæˆçš„ C++ ç¨‹å¼ç¢¼ï¼š
```cpp
MLPrediction predict_split_ml(double variance, double grad_h, double grad_v) {
    if (variance <= 5141.600098) {
        if (grad_h <= 62.218750) {
            return {false, 1.0000};
        } else {
            return {true, 1.0000};
        }
    }
    // ... æ›´å¤šåˆ†æ”¯
}
```

### 3. Confidence-based Fallback
- ä¸æ˜¯ã€Œå…¨ MLã€æˆ–ã€Œå…¨ RDOã€çš„äºŒé¸ä¸€
- æ ¹æ“š ML ä¿¡å¿ƒåº¦å‹•æ…‹æ±ºå®šç­–ç•¥
- å¯èª¿æ•´ Threshold æ§åˆ¶é€Ÿåº¦/å“è³ªæ¬Šè¡¡

### 4. Pareto Frontier è¦–è¦ºåŒ–
- é‡åŒ–ä¸åŒ Threshold çš„æ•ˆæœ
- å¹«åŠ©æ±ºç­–è€…é¸æ“‡æœ€é©é…ç½®
- ç¬¦åˆçœŸå¯¦ç”¢å“èª¿åƒæµç¨‹

---

## ğŸ’¡ å°ˆæ¡ˆè²¢ç»èˆ‡åƒ¹å€¼

### å°æ–¼é¢è©¦ / æŠ€è¡“å±•ç¤º

| å±•ç¤ºèƒ½åŠ› | å…·é«”å…§å®¹ |
|----------|----------|
| **C++ æ•ˆèƒ½å„ªåŒ–** | RDO è¨ˆç®—ã€è¨˜æ†¶é«”ç®¡ç†ã€ç·¨è­¯å™¨å„ªåŒ– (-O2) |
| **Python ML** | sklearn è¨“ç·´ã€æ¨¡å‹åˆ†æã€ç¨‹å¼ç¢¼ç”Ÿæˆ |
| **ç³»çµ±æ•´åˆ** | C++ â†” Python å·¥ä½œæµç¨‹è¨­è¨ˆ |
| **æ¼”ç®—æ³•è¨­è¨ˆ** | Quadtree éè¿´ã€Hybrid æ±ºç­–é‚è¼¯ |
| **è³‡æ–™åˆ†æ** | Pareto Frontierã€Trade-off åˆ†æ |
| **è¦–è¦ºåŒ–** | matplotlib åœ–è¡¨ã€çµæœå‘ˆç¾ |

### å°æ–¼å¯¦éš›æ‡‰ç”¨

1. **è¦–è¨Šç·¨ç¢¼åŠ é€Ÿ**: å¯æ•´åˆåˆ° HEVC/VVC Encoder
2. **åµŒå…¥å¼ç³»çµ±éƒ¨ç½²**: ML æ¨¡å‹ç·¨è­¯ç‚ºç´” C++ï¼Œç„¡éœ€é‹è¡Œæ™‚ä¾è³´
3. **åƒæ•¸èª¿å„ªæ¡†æ¶**: Threshold æ©Ÿåˆ¶å¯æ³›åŒ–åˆ°å…¶ä»– ML åŠ é€Ÿå ´æ™¯

---

## ğŸš€ æœªä¾†æ“´å±•æ–¹å‘

1. **å¢åŠ è¨“ç·´è³‡æ–™å¤šæ¨£æ€§**
   - ä½¿ç”¨çœŸå¯¦åœ–ç‰‡/è¦–è¨Šå¹€
   - ä¸åŒè§£æåº¦ã€ä¸åŒå…§å®¹é¡å‹

2. **å˜—è©¦æ›´è¤‡é›œçš„ ML æ¨¡å‹**
   - Random Forestï¼ˆé›†æˆå­¸ç¿’ï¼‰
   - XGBoostï¼ˆæ¢¯åº¦æå‡ï¼‰
   - è¼•é‡ç´šç¥ç¶“ç¶²è·¯

3. **å“è³ªæŒ‡æ¨™æ•´åˆ**
   - PSNR (Peak Signal-to-Noise Ratio)
   - SSIM (Structural Similarity Index)
   - BD-Rate (BjÃ¸ntegaard Delta Rate)

4. **çœŸå¯¦ç·¨ç¢¼å™¨æ•´åˆ**
   - x265 (HEVC é–‹æºå¯¦ä½œ)
   - VVenC (VVC é–‹æºå¯¦ä½œ)

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
Fast Block Partitioning/
â”œâ”€â”€ ground_truth.cpp       # Phase 1: Ground Truth ç”Ÿæˆ
â”œâ”€â”€ train_and_convert.py   # Phase 2: ML è¨“ç·´ & C++ è½‰è­¯
â”œâ”€â”€ main_hybrid.cpp        # Phase 3: Benchmark æ¸¬è©¦
â”œâ”€â”€ generate_image.py      # æ¸¬è©¦åœ–ç‰‡ç”Ÿæˆ
â”œâ”€â”€ plot_pareto.py         # Pareto åœ–è¡¨ç¹ªè£½
â”œâ”€â”€ ml_model_generated.h   # è‡ªå‹•ç”Ÿæˆçš„ ML æ¨¡å‹
â”œâ”€â”€ block_data.csv         # è¨“ç·´è³‡æ–™
â”œâ”€â”€ pareto_data.csv        # å¯¦é©—çµæœ
â”œâ”€â”€ pareto_frontier.png    # è¦–è¦ºåŒ–åœ–è¡¨
â”œâ”€â”€ dummy_image.png        # æ¸¬è©¦åœ–ç‰‡
â””â”€â”€ README.md              # å°ˆæ¡ˆèªªæ˜
```

---

## ğŸ† çµè«–

> æœ¬å°ˆæ¡ˆæˆåŠŸå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ **Confidence-based Hybrid æ©Ÿåˆ¶** å°‡ ML æ¨¡å‹æ•´åˆåˆ°å‚³çµ±ç·¨ç¢¼å™¨çš„æ±ºç­–æµç¨‹ä¸­ã€‚
>
> é€éèª¿æ•´ Threshold åƒæ•¸ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ **2.4x åŠ é€Ÿ + 62% æº–ç¢ºåº¦** åˆ° **1.16x åŠ é€Ÿ + 85% æº–ç¢ºåº¦** ä¹‹é–“éˆæ´»é¸æ“‡ï¼Œé€™æ­£æ˜¯çœŸå¯¦ç”¢å“é–‹ç™¼ä¸­ Rate Control å’Œ Quality Tuning çš„æ ¸å¿ƒæ€ç¶­ã€‚

---

*å°ˆæ¡ˆé€£çµ: https://github.com/hongyan1215/Fast-block-partitioning*
