# Fast Block Partitioning å°ˆæ¡ˆèªªæ˜

## ğŸ“Œ å°ˆæ¡ˆèƒŒæ™¯

åœ¨è¦–è¨Šç·¨ç¢¼ï¼ˆå¦‚ HEVCã€VVCï¼‰ä¸­ï¼Œ**å€å¡Šåˆ†å‰²æ±ºç­–ï¼ˆBlock Partitioning Decisionï¼‰** æ˜¯å½±éŸ¿ç·¨ç¢¼æ•ˆç‡çš„é—œéµæ­¥é©Ÿã€‚å‚³çµ±ç·¨ç¢¼å™¨ä½¿ç”¨ **RDOï¼ˆRate-Distortion Optimizationï¼‰** æš´åŠ›æœå°‹æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²æ–¹å¼ï¼Œé›–ç„¶æº–ç¢ºä½†æ¥µåº¦è€—æ™‚ã€‚

æœ¬å°ˆæ¡ˆå±•ç¤ºå¦‚ä½•ä½¿ç”¨ **æ©Ÿå™¨å­¸ç¿’ï¼ˆMLï¼‰** åŠ é€Ÿé€™å€‹æ±ºç­–éç¨‹ï¼Œå¯¦ç¾ **é€Ÿåº¦èˆ‡å“è³ªçš„æ¬Šè¡¡**ã€‚

---

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™

1. **æ¨¡æ“¬çœŸå¯¦ç·¨ç¢¼å™¨çš„ RDO è¨ˆç®—** â€” ä¸æ˜¯å‡çš„å»¶é²æ¨¡æ“¬
2. **è¨“ç·´ ML æ¨¡å‹é æ¸¬åˆ†å‰²æ±ºç­–** â€” Decision Tree äºŒå…ƒåˆ†é¡å™¨
3. **å¯¦ä½œ Confidence-based Hybrid æ©Ÿåˆ¶** â€” ä¿¡å¿ƒåº¦æ±ºå®šç­–ç•¥
4. **é‡åŒ– Speed vs Accuracy Trade-off** â€” Pareto Frontier åˆ†æ

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¼¸å…¥åœ–ç‰‡ (64Ã—64)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰¹å¾µè¨ˆç®— (Feature Extraction)             â”‚
â”‚  â€¢ Variance (è®Šç•°æ•¸) â€” å€å¡Šè¤‡é›œåº¦                            â”‚
â”‚  â€¢ Gradient_H (æ°´å¹³æ¢¯åº¦) â€” æ°´å¹³ç´‹ç†å¼·åº¦                      â”‚
â”‚  â€¢ Gradient_V (å‚ç›´æ¢¯åº¦) â€” å‚ç›´ç´‹ç†å¼·åº¦                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ML æ¨¡å‹é æ¸¬ (Binary Model)                â”‚
â”‚  è¼¸å‡º: {should_split: bool, confidence: 0.5~1.0}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
    confidence >= threshold?           confidence < threshold?
              â”‚                               â”‚
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½¿ç”¨ ML é æ¸¬çµæœ       â”‚     â”‚   å›é€€åˆ° RDO è¨ˆç®—        â”‚
â”‚   (å¿«é€Ÿè·¯å¾‘)             â”‚     â”‚   (ç²¾ç¢ºè·¯å¾‘)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸ·è¡Œåˆ†å‰²æ±ºç­–                              â”‚
â”‚  â€¢ Split â†’ éè¿´è™•ç† 4 å€‹å­å€å¡Š                               â”‚
â”‚  â€¢ No Split â†’ è©²å€å¡Šç‚ºæœ€çµ‚ç·¨ç¢¼å–®ä½                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ ¸å¿ƒæ¼”ç®—æ³•

### 0. Quadtree Partitioningï¼ˆå››å…ƒæ¨¹åˆ†å‰²ï¼‰åŸºç¤

#### ç‚ºä»€éº¼éœ€è¦å€å¡Šåˆ†å‰²ï¼Ÿ

åœ¨è¦–è¨Šç·¨ç¢¼ï¼ˆHEVC/VVCï¼‰ä¸­ï¼Œç•«é¢æœƒè¢«åˆ‡æˆ**æ¨¹ç‹€çµæ§‹çš„å€å¡Š**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚                      64Ã—64 CTU                                â”‚
â”‚        (Coding Tree Unit - æœ€å¤§ç·¨ç¢¼å–®ä½)                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 32Ã—32  â”‚      â”‚ 32Ã—32  â”‚      â”‚  ...   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
      â–¼       â–¼       â–¼
   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
   â”‚16Ã—16â”‚ â”‚16Ã—16â”‚ â”‚ ... â”‚
   â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

#### (x, y, size) çš„æ„ç¾©

```cpp
compute_variance(img, x, y, size)
//                    â”‚  â”‚   â”‚
//                    â”‚  â”‚   â””â”€â”€ å€å¡Šé‚Šé•· (64, 32, 16, 8, 4)
//                    â”‚  â””â”€â”€â”€â”€â”€â”€ å€å¡Šå·¦ä¸Šè§’çš„ Y åº§æ¨™
//                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ å€å¡Šå·¦ä¸Šè§’çš„ X åº§æ¨™
```

**è¦–è¦ºåŒ–ç¯„ä¾‹ï¼š**

```
   x=0       x=32
    â”‚         â”‚
    â–¼         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† y=0
   â”‚         â”‚         â”‚
   â”‚  å€å¡ŠA  â”‚  å€å¡ŠB  â”‚
   â”‚ (0,0)   â”‚ (32,0)  â”‚
   â”‚ size=32 â”‚ size=32 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â† y=32
   â”‚         â”‚         â”‚
   â”‚  å€å¡ŠC  â”‚  å€å¡ŠD  â”‚
   â”‚ (0,32)  â”‚(32,32)  â”‚
   â”‚         â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®Šç•°æ•¸ (Variance) è¨ˆç®—

**æ•¸å­¸å…¬å¼ï¼š**

```
Variance = E[XÂ²] - (E[X])Â²
         = (Î£xÂ²/N) - (Î£x/N)Â²
```

**ç¨‹å¼ç¢¼å¯¦ä½œï¼š**

```cpp
double compute_variance(img, x, y, size) {
    double sum = 0.0;      // Î£x_i
    double sq_sum = 0.0;   // Î£x_iÂ²
    int N = size * size;   // å€å¡Šå…§çš„åƒç´ æ•¸é‡

    // éæ­·å€å¡Šå…§æ‰€æœ‰åƒç´ 
    for (int i = 0; i < size; ++i) {
        for (int j = 0; j < size; ++j) {
            int val = img[y + i][x + j];
            sum += val;           // ç´¯åŠ åƒç´ å€¼
            sq_sum += val * val;  // ç´¯åŠ åƒç´ å€¼çš„å¹³æ–¹
        }
    }
    
    double mean = sum / N;                        // Î¼ = Î£x / N
    double variance = (sq_sum / N) - (mean * mean);
    //                 â””â”€ E[XÂ²] â”€â”˜   â””â”€ (E[X])Â² â”€â”˜
    return variance;
}
```

**è¨ˆç®—ç¯„ä¾‹ï¼š**

å‡è¨­æœ‰ä¸€å€‹ 2Ã—2 å€å¡Šï¼š
```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  10 â”‚  20 â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚  30 â”‚  40 â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

| æ­¥é©Ÿ | è¨ˆç®— | çµæœ |
|------|------|------|
| N | 2 Ã— 2 | **4** |
| sum | 10 + 20 + 30 + 40 | **100** |
| sq_sum | 100 + 400 + 900 + 1600 | **3000** |
| mean | 100 / 4 | **25** |
| variance | (3000/4) - (25Â²) = 750 - 625 | **125** |

#### ç‚ºä»€éº¼ç”¨è®Šç•°æ•¸æ±ºå®šåˆ‡åˆ†ï¼Ÿ

**æ ¸å¿ƒé‚è¼¯ï¼šå€å¡Šå…§å®¹è¶Šè¤‡é›œ â†’ éœ€è¦æ›´å°çš„å€å¡Šä¾†ç²¾ç¢ºç·¨ç¢¼**

| å€å¡Šé¡å‹ | è®Šç•°æ•¸ | è¦–è¦ºæ•ˆæœ | ç·¨ç¢¼ç­–ç•¥ |
|----------|--------|----------|----------|
| **å¹³æ»‘å€** | ä½ | ç´”è‰²å¤©ç©ºã€ç‰†å£ | ç”¨å¤§å€å¡Šï¼Œçœ bits |
| **ç´‹ç†å€** | é«˜ | è‰åœ°ã€æ¨¹è‘‰ã€æ–‡å­— | åˆ‡å°å€å¡Šï¼Œä¿ç´°ç¯€ |

**ç¯„ä¾‹ï¼š**

```
å¹³æ»‘å€å¡Š (è®Šç•°æ•¸ â‰ˆ 0)          ç´‹ç†å€å¡Š (è®Šç•°æ•¸ â‰ˆ 2000)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚100 100 100 100 â”‚            â”‚ 10 200  50 180 â”‚
â”‚100 100 100 100 â”‚            â”‚220  30 190  70 â”‚
â”‚100 100 100 100 â”‚  vs.       â”‚ 80 160  20 240 â”‚
â”‚100 100 100 100 â”‚            â”‚170  90 210  40 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âŒ ä¸åˆ‡åˆ†                       âœ… éœ€è¦åˆ‡åˆ†
   (ç”¨ 16Ã—16 ç·¨ç¢¼)               (åˆ‡æˆ 4 å€‹ 8Ã—8)
```

#### éè¿´åˆ†å‰²çš„å®Œæ•´æµç¨‹

```cpp
void recursive_partition(img, x, y, size) {
    // 1. è¨ˆç®—é€™å€‹å€å¡Šçš„è®Šç•°æ•¸
    double var = compute_variance(img, x, y, size);
    
    // 2. æ±ºå®šæ˜¯å¦åˆ‡åˆ†
    if (var > THRESHOLD && size > MIN_SIZE) {
        // è®Šç•°æ•¸å¤ªé«˜ â†’ åˆ‡æˆ 4 å€‹å­å€å¡Š
        int half = size / 2;
        recursive_partition(img, x,        y,        half);  // å·¦ä¸Š
        recursive_partition(img, x + half, y,        half);  // å³ä¸Š
        recursive_partition(img, x,        y + half, half);  // å·¦ä¸‹
        recursive_partition(img, x + half, y + half, half);  // å³ä¸‹
    } else {
        // è®Šç•°æ•¸å¤ ä½ â†’ åœæ­¢åˆ‡åˆ†ï¼Œè¨˜éŒ„é€™å€‹å€å¡Š
        record_block(x, y, size);
    }
}
```

**è¦–è¦ºåŒ–éè¿´éç¨‹ï¼š**

```
Step 1: æª¢æŸ¥ 64Ã—64          Step 2: åˆ‡æˆ 4 å€‹ 32Ã—32
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚       â”‚ è®Šç•°æ•¸ä½ â”‚ è®Šç•°æ•¸é«˜ â”‚
â”‚    è®Šç•°æ•¸ = 5000  â”‚  â”€â”€â–º  â”‚  åœæ­¢   â”‚  ç¹¼çºŒåˆ‡  â”‚
â”‚    (å¤ªé«˜ï¼Œè¦åˆ‡)    â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚       â”‚ è®Šç•°æ•¸é«˜ â”‚ è®Šç•°æ•¸ä½ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  ç¹¼çºŒåˆ‡  â”‚  åœæ­¢   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: æœ€çµ‚çµæœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚         â”‚    â”‚    â”‚
â”‚  32Ã—32  â”‚16Ã—16â”‚16Ã—16â”‚
â”‚         â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚8Ã—8 â”‚8Ã—8 â”‚16Ã—16â”‚16Ã—16â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚8Ã—8 â”‚8Ã—8 â”‚         â”‚
â”œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¤  32Ã—32  â”‚
â”‚  16Ã—16  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¢¯åº¦ (Gradient) è¨ˆç®—

**æ¢¯åº¦æ˜¯ä»€éº¼ï¼Ÿ**

æ¢¯åº¦ = ç›¸é„°åƒç´ ä¹‹é–“çš„è®ŠåŒ–é‡

- **æ°´å¹³æ¢¯åº¦ (grad_h)**ï¼šå·¦å³åƒç´ çš„å·®ç•° â†’ åµæ¸¬**å‚ç›´é‚Šç·£**
- **å‚ç›´æ¢¯åº¦ (grad_v)**ï¼šä¸Šä¸‹åƒç´ çš„å·®ç•° â†’ åµæ¸¬**æ°´å¹³é‚Šç·£**

```
æ°´å¹³æ¢¯åº¦åµæ¸¬å‚ç›´é‚Šç·£          å‚ç›´æ¢¯åº¦åµæ¸¬æ°´å¹³é‚Šç·£
        
  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”
  â”‚100â”‚200â”‚ â† å·®å€¼=100         â”‚  100  â”‚
  â””â”€â”€â”€â”´â”€â”€â”€â”˜                    â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
     â–²                         â”‚  200  â”‚ â† å·®å€¼=100
     â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”˜
  å‚ç›´é‚Šç·£                      æ°´å¹³é‚Šç·£
```

**ç¨‹å¼ç¢¼è§£æï¼š**

```cpp
void compute_gradients(img, x, y, size, grad_h, grad_v) {
    grad_h = 0.0;  // æ°´å¹³æ¢¯åº¦ç´¯è¨ˆ
    grad_v = 0.0;  // å‚ç›´æ¢¯åº¦ç´¯è¨ˆ
    
    for (int i = 0; i < size; ++i) {
        for (int j = 0; j < size; ++j) {
            // æ°´å¹³æ¢¯åº¦ï¼šæ¯”è¼ƒ [ç•¶å‰åƒç´ ] å’Œ [å³é‚Šåƒç´ ]
            if (j + 1 < size) 
                grad_h += abs(img[y+i][x+j] - img[y+i][x+j+1]);
            //                â””â”€ ç•¶å‰ â”€â”˜   â””â”€â”€ å³é‚Š â”€â”€â”˜
            
            // å‚ç›´æ¢¯åº¦ï¼šæ¯”è¼ƒ [ç•¶å‰åƒç´ ] å’Œ [ä¸‹æ–¹åƒç´ ]
            if (i + 1 < size) 
                grad_v += abs(img[y+i][x+j] - img[y+i+1][x+j]);
            //                â””â”€ ç•¶å‰ â”€â”˜   â””â”€â”€ ä¸‹æ–¹ â”€â”€â”˜
        }
    }
    
    // æ­£è¦åŒ–ï¼šé™¤ä»¥åƒç´ æ•¸é‡ï¼Œè®“ä¸åŒ size çš„å€å¡Šå¯ä»¥æ¯”è¼ƒ
    grad_h /= (size * size);
    grad_v /= (size * size);
}
```

**è¨ˆç®—ç¯„ä¾‹ï¼š**

å‡è¨­æœ‰ä¸€å€‹ 3Ã—3 å€å¡Šï¼Œä¸­é–“æœ‰å‚ç›´é‚Šç·£ï¼š

```
     j=0   j=1   j=2
    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
i=0 â”‚ 100 â”‚ 100 â”‚ 200 â”‚
    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
i=1 â”‚ 100 â”‚ 100 â”‚ 200 â”‚
    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
i=2 â”‚ 100 â”‚ 100 â”‚ 200 â”‚
    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚
      å‚ç›´é‚Šç·£åœ¨é€™è£¡
```

| æ¢¯åº¦é¡å‹ | è¨ˆç®—éç¨‹ | çµæœ |
|----------|----------|------|
| grad_h (æ°´å¹³) | \|100-100\|Ã—3 + \|100-200\|Ã—3 = 0 + 300 | 300/9 = **33.3** |
| grad_v (å‚ç›´) | æ‰€æœ‰ä¸Šä¸‹å·®éƒ½æ˜¯ 0 | 0/9 = **0** |

**çµæœè§£è®€ï¼š** `grad_h = 33.3` (é«˜) è¡¨ç¤ºæœ‰å‚ç›´é‚Šç·£ï¼Œ`grad_v = 0` è¡¨ç¤ºæ²’æœ‰æ°´å¹³é‚Šç·£ã€‚

**æ¢¯åº¦ vs è®Šç•°æ•¸çš„å·®ç•°ï¼š**

| ç‰¹å¾µ | åµæ¸¬ç›®æ¨™ | é«˜å€¼ä»£è¡¨ |
|------|----------|----------|
| **Variance** | æ•´é«”è¤‡é›œåº¦ | å€å¡Šå…§é¡è‰²è®ŠåŒ–å¤§ |
| **grad_h** | å‚ç›´é‚Šç·£ | æœ‰å·¦å³æ–¹å‘çš„é¡è‰²è·³è®Š |
| **grad_v** | æ°´å¹³é‚Šç·£ | æœ‰ä¸Šä¸‹æ–¹å‘çš„é¡è‰²è·³è®Š |

**ç‚ºä»€éº¼éœ€è¦æ¢¯åº¦ä½œç‚ºç‰¹å¾µï¼Ÿ**

åªé è®Šç•°æ•¸ä¸å¤ ï¼çœ‹é€™å€‹ä¾‹å­ï¼š

```
å€å¡Š A (æ£‹ç›¤ç´‹ç†)           å€å¡Š B (å‚ç›´é‚Šç·£)
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”         â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 0 â”‚255â”‚ 0 â”‚255â”‚         â”‚ 0 â”‚ 0 â”‚255â”‚255â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤         â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚255â”‚ 0 â”‚255â”‚ 0 â”‚         â”‚ 0 â”‚ 0 â”‚255â”‚255â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤         â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚ 0 â”‚255â”‚ 0 â”‚255â”‚         â”‚ 0 â”‚ 0 â”‚255â”‚255â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤         â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚255â”‚ 0 â”‚255â”‚ 0 â”‚         â”‚ 0 â”‚ 0 â”‚255â”‚255â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜         â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

Variance: é«˜              Variance: é«˜
grad_h: é«˜                grad_h: é«˜
grad_v: é«˜                grad_v: ä½ â† å·®ç•°åœ¨é€™ï¼
```

**çµè«–ï¼šæ¢¯åº¦èƒ½å€åˆ†ä¸åŒé¡å‹çš„ç´‹ç†ï¼Œå¹«åŠ© ML æ¨¡å‹åšå‡ºæ›´æº–ç¢ºçš„é æ¸¬ï¼**

**æ­£è¦åŒ–çš„æ„ç¾©ï¼š**

```cpp
grad_h /= (size * size);
grad_v /= (size * size);
```

| å€å¡Šå¤§å° | æœªæ­£è¦åŒ– | æ­£è¦åŒ–å¾Œ |
|----------|----------|----------|
| 4Ã—4 | 2400 | 150 |
| 8Ã—8 | 11200 | 175 |
| 16Ã—16 | 48000 | 187 |

æ­£è¦åŒ–å¾Œï¼Œä¸åŒå¤§å°çš„å€å¡Šå¯ä»¥å…¬å¹³æ¯”è¼ƒï¼

**ä¸‰å€‹ç‰¹å¾µåœ¨ ML æ¨¡å‹ä¸­çš„ä½œç”¨ï¼š**

```
ç‰¹å¾µå‘é‡ = [variance, grad_h, grad_v]
                â”‚        â”‚       â”‚
                â”‚        â”‚       â””â”€â”€ æœ‰æ²’æœ‰æ°´å¹³é‚Šç·£ï¼Ÿ
                â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœ‰æ²’æœ‰å‚ç›´é‚Šç·£ï¼Ÿ
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•´é«”è¤‡é›œåº¦å¦‚ä½•ï¼Ÿ
```

Decision Tree å¯ä»¥å­¸åˆ°é€™æ¨£çš„è¦å‰‡ï¼š
- å¦‚æœ `variance > 1000` ä¸” `grad_h > 50` â†’ **åˆ‡åˆ†**ï¼ˆæœ‰æ˜é¡¯é‚Šç·£ï¼‰
- å¦‚æœ `variance < 100` â†’ **ä¸åˆ‡**ï¼ˆå¹³æ»‘å€åŸŸï¼‰
- å¦‚æœ `grad_h` å’Œ `grad_v` éƒ½å¾ˆä½ â†’ **ä¸åˆ‡**ï¼ˆå‡å‹»ç´‹ç†ï¼‰

---

### 1. RDO (Rate-Distortion Optimization)

```
RD Cost = Distortion + Î» Ã— Rate
```

| é …ç›® | è¨ˆç®—æ–¹å¼ | æ„ç¾© |
|------|----------|------|
| **Distortion** | SSD (Sum of Squared Differences) | å¤±çœŸç¨‹åº¦ |
| **Rate** | logâ‚‚(variance + 1) Ã— block_area | ç·¨ç¢¼ä½å…ƒæ•¸ä¼°è¨ˆ |
| **Î» (Lambda)** | 0.5 (å¯èª¿æ•´) | Rate-Distortion æ¬Šè¡¡å› å­ |

### 2. ML æ¨¡å‹ï¼ˆDecision Treeï¼‰

- **è¼¸å…¥ç‰¹å¾µ**: variance, grad_h, grad_v
- **è¼¸å‡º**: {should_split, confidence}
- **æ·±åº¦é™åˆ¶**: max_depth = 4ï¼ˆå„ªåŒ– Branch Predictionï¼‰

#### ML é æ¸¬æµç¨‹è©³è§£

**Step 1: ç‰¹å¾µæå–**

å°æ–¼æ¯å€‹å¾…æ±ºç­–çš„å€å¡Šï¼Œè¨ˆç®—ä¸‰å€‹ç‰¹å¾µï¼š

```cpp
// 1. è®Šç•°æ•¸ (Variance) - è¡¡é‡å€å¡Šå…§åƒç´ å€¼çš„åˆ†æ•£ç¨‹åº¦
double variance = Î£(pixel - mean)Â² / n

// 2. æ°´å¹³æ¢¯åº¦ (Gradient_H) - ç›¸é„°åƒç´ çš„æ°´å¹³å·®ç•°
double grad_h = Î£|pixel[i,j] - pixel[i,j+1]| / n

// 3. å‚ç›´æ¢¯åº¦ (Gradient_V) - ç›¸é„°åƒç´ çš„å‚ç›´å·®ç•°  
double grad_v = Î£|pixel[i,j] - pixel[i+1,j]| / n
```

**Step 2: Decision Tree æ±ºç­–è·¯å¾‘**

Decision Tree é€éä¸€ç³»åˆ— if-else åˆ¤æ–·ä¾†é æ¸¬ï¼š

```
                    [variance <= 5141.6?]
                    /                    \
                  Yes                     No
                  /                         \
        [grad_h <= 62.2?]              [variance <= 5754.1?]
        /              \                /                \
      Yes              No             Yes                No
      /                 \             /                   \
[grad_h <= 18.2?]    Split=1     [variance<=5577.7?]   [variance<=8911.5?]
   /        \        Conf=1.0     /           \          /           \
 Yes        No                  Yes           No       Yes           No
  |          |                   |             |        |             |
Split=0    Split=0           Split=0       Split=1   Split=0      Split=1
Conf=0.8   Conf=1.0          Conf=0.6      Conf=0.85 Conf=0.93    Conf=1.0
```

**Step 3: è‘‰ç¯€é»çš„ Confidence è¨ˆç®—**

æ¯å€‹è‘‰ç¯€é»çš„ Confidence ä¾†è‡ªè¨“ç·´æ™‚çš„çµ±è¨ˆï¼š

```
Confidence = å¤šæ•¸é¡åˆ¥æ¨£æœ¬æ•¸ / ç¸½æ¨£æœ¬æ•¸
```

ä¾‹å¦‚ï¼šæŸè‘‰ç¯€é»æœ‰ 80 å€‹ã€Œä¸åˆ‡ã€æ¨£æœ¬ + 20 å€‹ã€Œåˆ‡ã€æ¨£æœ¬
â†’ é æ¸¬ã€Œä¸åˆ‡ã€ï¼ŒConfidence = 80/100 = 0.80

**Step 4: å¯¦éš› C++ ç¨‹å¼ç¢¼**

```cpp
MLPrediction predict_split_ml(double variance, double grad_h, double grad_v) {
    if (variance <= 5141.600098) {
        if (grad_h <= 62.218750) {
            if (grad_h <= 18.218750) {
                if (variance <= 0.000000) {
                    // è¨“ç·´æ™‚ï¼š32å€‹æ¨£æœ¬å…¨æ˜¯ã€Œä¸åˆ‡ã€
                    return {false, 1.0000};  // 100% ä¿¡å¿ƒä¸åˆ‡
                } else {
                    // è¨“ç·´æ™‚ï¼š52å€‹ã€Œä¸åˆ‡ã€+ 13å€‹ã€Œåˆ‡ã€
                    return {false, 0.8000};  // 80% ä¿¡å¿ƒä¸åˆ‡
                }
            } else {
                return {false, 1.0000};
            }
        } else {
            return {true, 1.0000};  // é«˜æ¢¯åº¦ â†’ 100% ä¿¡å¿ƒè¦åˆ‡
        }
    } else {
        // é«˜è®Šç•°æ•¸å€åŸŸçš„æ±ºç­–...
        if (variance <= 5754.145020) {
            if (variance <= 5577.659912) {
                return {false, 0.6111};  // 61% ä¿¡å¿ƒï¼Œè¼ƒä¸ç¢ºå®š
            } else {
                return {true, 0.8462};
            }
        } else {
            if (variance <= 8911.485352) {
                return {false, 0.9286};
            } else {
                return {true, 1.0000};  // æ¥µé«˜è®Šç•°æ•¸ â†’ ä¸€å®šè¦åˆ‡
            }
        }
    }
}
```

**Step 5: Confidence çš„å¯¦éš›æ„ç¾©**

| Confidence ç¯„åœ | æ„ç¾© | Hybrid ç­–ç•¥å»ºè­° |
|----------------|------|-----------------|
| 0.95 ~ 1.0 | ML éå¸¸ç¢ºå®š | ç›´æ¥æ¡ç”¨ ML çµæœ |
| 0.80 ~ 0.95 | ML è¼ƒç¢ºå®š | å¯æ¡ç”¨ ML çµæœ |
| 0.60 ~ 0.80 | ML ä¸å¤ªç¢ºå®š | è€ƒæ…®å›é€€åˆ° RDO |
| 0.50 ~ 0.60 | ML åŸºæœ¬æ˜¯çŒœçš„ | æ‡‰è©²å›é€€åˆ° RDO |

**ç‚ºä»€éº¼ç”¨ Decision Treeï¼Ÿ**

1. **æ¨è«–é€Ÿåº¦æ¥µå¿«** â€” åªæœ‰ if-else åˆ¤æ–·ï¼Œç„¡çŸ©é™£é‹ç®—
2. **å¯è§£é‡‹æ€§å¼·** â€” æ¯å€‹æ±ºç­–è·¯å¾‘éƒ½å¯è¿½æº¯
3. **é›¶ä¾è³´éƒ¨ç½²** â€” è½‰æˆç´” C++ ç¨‹å¼ç¢¼ï¼Œç„¡éœ€ ML æ¡†æ¶
4. **Branch Prediction å‹å¥½** â€” é™åˆ¶æ·±åº¦ï¼ŒCPU é æ¸¬å‘½ä¸­ç‡é«˜

#### Python è¨“ç·´è…³æœ¬è©³è§£ (train_and_convert.py)

**æ•´é«”æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    train_and_convert.py                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
   [Step 1]              [Step 2]              [Step 3]
   è¼‰å…¥è³‡æ–™               è¨“ç·´æ¨¡å‹              åˆ†æä¿¡å¿ƒåº¦
   block_data.csv    Decision Tree         Confidence åˆ†å¸ƒ
        â”‚                     â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                         [Step 4]
                      è½‰è­¯ç‚º C++ ç¨‹å¼ç¢¼
                              â”‚
                              â–¼
                    ml_model_generated.h
```

**Step 1: è¼‰å…¥ Ground Truth è³‡æ–™**

```python
df = pd.read_csv("block_data.csv")

# è³‡æ–™æ ¼å¼ï¼ˆç”± Phase 1 çš„ C++ ç”¢ç”Ÿï¼‰ï¼š
# | variance | grad_h | grad_v | label |
# |----------|--------|--------|-------|
# | 0.0      | 0.0    | 0.0    | 0     |
# | 8500.0   | 120.3  | 95.6   | 1     |

feature_names = ['variance', 'grad_h', 'grad_v']
X = df[feature_names]  # ç‰¹å¾µçŸ©é™£ (N Ã— 3)
y = df['label']        # æ¨™ç±¤å‘é‡ (1=åˆ‡åˆ†, 0=ä¸åˆ‡)
```

**Step 2: è¨“ç·´ Decision Tree**

```python
# åˆ‡åˆ†è¨“ç·´/æ¸¬è©¦é›† (80% è¨“ç·´, 20% æ¸¬è©¦)
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# è¨“ç·´ Decision Tree
clf = DecisionTreeClassifier(max_depth=4, random_state=42)
clf.fit(X_train, y_train)

# é©—è­‰æº–ç¢ºåº¦
y_pred = clf.predict(X_test)
acc = accuracy_score(y_test, y_pred)  # çµæœï¼šç´„ 70%
```

**ç‚ºä»€éº¼ max_depth=4ï¼Ÿ**

| Depth | å„ªé» | ç¼ºé» |
|-------|------|------|
| æ·º (2-3) | è¶…å¿«æ¨è«–ã€é¿å…éæ“¬åˆ | æº–ç¢ºåº¦è¼ƒä½ |
| **4** | **å¹³è¡¡é€Ÿåº¦èˆ‡æº–ç¢ºåº¦** | **æœ€ä½³é¸æ“‡** |
| æ·± (5+) | é«˜æº–ç¢ºåº¦ | éæ“¬åˆã€æ¨è«–è®Šæ…¢ |

**Step 3: åˆ†æ Confidence åˆ†å¸ƒ**

```python
y_proba = clf.predict_proba(X_test)  # å–å¾—æ©Ÿç‡é æ¸¬
confidences = np.max(y_proba, axis=1)  # å–è¼ƒå¤§çš„é‚£å€‹æ©Ÿç‡

# predict_proba ç¯„ä¾‹ï¼š
# è¼¸å…¥: [variance=1000, grad_h=50, grad_v=30]
# è¼¸å‡º: [P(ä¸åˆ‡åˆ†), P(åˆ‡åˆ†)] = [0.15, 0.85]
#       â†’ Confidence = 85%
```

**Step 4: è½‰è­¯ç‚º C++ ç¨‹å¼ç¢¼ï¼ˆæ ¸å¿ƒé­”æ³•ï¼ï¼‰**

æŠŠ sklearn çš„ Decision Tree **ç›´æ¥è½‰æˆ C++ if-else**ï¼š

```python
def tree_to_cpp_with_confidence(tree, feature_names):
    tree_ = tree.tree_  # sklearn å…§éƒ¨æ¨¹çµæ§‹
    
    # sklearn Decision Tree çš„å…§éƒ¨çµæ§‹ï¼š
    # tree_.feature[node]     â†’ é€™å€‹ç¯€é»ç”¨å“ªå€‹ç‰¹å¾µåˆ‡åˆ†
    # tree_.threshold[node]   â†’ åˆ‡åˆ†é–¾å€¼
    # tree_.children_left[node]  â†’ å·¦å­ç¯€é» (â‰¤ threshold)
    # tree_.children_right[node] â†’ å³å­ç¯€é» (> threshold)
    # tree_.value[node]       â†’ è‘‰ç¯€é»çš„æ¨£æœ¬çµ±è¨ˆ
    
    def recurse(node, depth):
        if tree_.feature[node] != TREE_UNDEFINED:
            # æ±ºç­–ç¯€é» â†’ ç”Ÿæˆ if-else
            name = feature_name[node]
            threshold = tree_.threshold[node]
            
            lines.append(f"if ({name} <= {threshold}) {{")
            recurse(left_child)   # éè¿´è™•ç†å·¦å­æ¨¹
            lines.append("} else {")
            recurse(right_child)  # éè¿´è™•ç†å³å­æ¨¹
            lines.append("}")
        else:
            # è‘‰ç¯€é» â†’ ç”Ÿæˆ return èªå¥
            value = tree_.value[node][0]  # [ä¸åˆ‡åˆ†æ•¸, åˆ‡åˆ†æ•¸]
            class_idx = value.argmax()    # å¤šæ•¸æ±º
            confidence = value[class_idx] / value.sum()
            
            lines.append(f"return {{{class_idx}, {confidence}}};")
```

**è½‰è­¯ç¯„ä¾‹ï¼š**

```
sklearn æ¨¹çµæ§‹:              è½‰è­¯å¾Œçš„ C++ ç¨‹å¼ç¢¼:
                    
      variance                if (variance <= 1234.5) {
      â‰¤ 1234.5?                   if (grad_h <= 50.0) {
      /      \                        return {false, 0.95};
   grad_h    [åˆ‡åˆ†]               } else {
   â‰¤ 50?     ä¿¡å¿ƒ90%                  return {true, 0.80};
   /    \                         }
[ä¸åˆ‡]  [åˆ‡åˆ†]               } else {
ä¿¡å¿ƒ95% ä¿¡å¿ƒ80%                  return {true, 0.90};
                             }
```

**ç”Ÿæˆçš„ C++ ç¨‹å¼ç¢¼ (ml_model_generated.h)ï¼š**

```cpp
struct MLPrediction {
    bool should_split;   // é æ¸¬çµæœ
    double confidence;   // ä¿¡å¿ƒåº¦ (0.0 ~ 1.0)
};

MLPrediction predict_split_ml(double variance, double grad_h, double grad_v) {
    if (variance <= 0.000000) {
        return {false, 1.0000};  // 100% ç¢ºå®šä¸åˆ‡
    } else {
        if (grad_h <= 45.123456) {
            return {false, 0.7500};  // 75% ç¢ºå®šä¸åˆ‡
        } else {
            return {true, 0.9333};   // 93% ç¢ºå®šè¦åˆ‡
        }
    }
}
```

**å®Œæ•´æµç¨‹åœ–ï¼š**

```
Phase 1 (C++)                    Phase 2 (Python)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ground_truthâ”‚                  â”‚     train_and_convert.py        â”‚
â”‚    .cpp     â”‚                  â”‚                                 â”‚
â”‚             â”‚   block_data.csv â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ ç”¢ç”Ÿè¨“ç·´è³‡æ–™ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”‚ è¼‰å…¥ CSV  â”‚                  â”‚
â”‚             â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚        â–¼                        â”‚
                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
                                 â”‚  â”‚ è¨“ç·´ Tree â”‚                  â”‚
                                 â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â”‚
                                 â”‚        â–¼                        â”‚
                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
                                 â”‚  â”‚ è½‰è­¯ C++  â”‚                  â”‚
                                 â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ml_model_generatedâ”‚
                                 â”‚      .h         â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ main_hybrid.cpp â”‚
                                 â”‚  (ç›´æ¥ include) â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‚ºä»€éº¼è¦ç›´æ¥è½‰è­¯æˆ C++ if-elseï¼Ÿ**

| æ–¹æ³• | å„ªé» | ç¼ºé» |
|------|------|------|
| Python å‘¼å« sklearn | ç°¡å–® | è¶…æ…¢ã€éœ€è¦ Python runtime |
| ONNX / TensorRT | æ¨™æº–åŒ– | è¤‡é›œã€ä¾è³´å¤š |
| **ç›´æ¥è½‰è­¯æˆ C++ if-else** | **æ¥µå¿«ã€é›¶ä¾è³´** | åªé©ç”¨ç°¡å–®æ¨¡å‹ |

å°æ–¼ Decision Treeï¼Œç›´æ¥è½‰è­¯æ˜¯**æœ€ä½³é¸æ“‡**ï¼š
- æ¨è«–æ™‚é–“ï¼š**< 1 Î¼s**ï¼ˆç´” if-elseï¼‰
- éƒ¨ç½²é›£åº¦ï¼š**é›¶**ï¼ˆç›´æ¥ #includeï¼‰
- é©åˆåµŒå…¥å¼ / Real-time ç’°å¢ƒ

### 3. Hybrid ç­–ç•¥

```cpp
if (ml_prediction.confidence >= threshold) {
    // ML æœ‰ä¿¡å¿ƒ â†’ å¿«é€Ÿè·¯å¾‘
    return ml_prediction.should_split;
} else {
    // ML æ²’ä¿¡å¿ƒ â†’ å›é€€åˆ°ç²¾ç¢ºçš„ RDO
    return rdo_result.should_split;
}
```

---

## ğŸ“ˆ å¯¦é©—çµæœ

### æ¸¬è©¦åœ–ç‰‡èˆ‡åˆ†æ

![æ¸¬è©¦åœ–ç‰‡åˆ†æ](../dummy_image_analysis.png)

### ä¸åŒ Threshold çš„åˆ†å‰²çµæœè¦–è¦ºåŒ–

![åˆ†å‰²çµæœæ¯”è¼ƒ](../partition_comparison.png)

**åœ–ä¾‹èªªæ˜ï¼š**
| é¡è‰² | å€å¡Šå¤§å° |
|------|----------|
| ğŸ”´ ç´…è‰² | 64Ã—64ï¼ˆä¸åˆ‡åˆ†ï¼‰|
| ğŸ©µ é’è‰² | 32Ã—32 |
| ğŸ”µ è—è‰² | 16Ã—16 |
| ğŸŸ¢ ç¶ è‰² | 8Ã—8 |
| ğŸŸ¡ é»ƒè‰² | 4Ã—4ï¼ˆæœ€å°å–®ä½ï¼‰|

### ML-Only vs C Model vs Hybrid æ¯”è¼ƒ

![æ¨¡å‹æ¯”è¼ƒ](../partition_ml_vs_c.png)

### Pareto Frontierï¼ˆé€Ÿåº¦ vs æº–ç¢ºåº¦æ¬Šè¡¡æ›²ç·šï¼‰

![Pareto Frontier](../pareto_frontier.png)

> **æ¸¬è©¦èªªæ˜**: ä»¥ä¸‹çµæœç‚º **3 æ¬¡ç¨ç«‹åŸ·è¡Œçš„å¹³å‡å€¼**ï¼ŒC Model baseline ç´„ 47.6 Î¼s

| Threshold | æ™‚é–“ (Î¼s) | åŠ é€Ÿæ¯” | æº–ç¢ºåº¦ | RDO é‹ç®—æ¬¡æ•¸ |
|-----------|-----------|--------|--------|--------------|
| 0.50 | 8.63 | **5.51x** Â± 0.22 | 15.34% | 0 |
| 0.60 | 17.52 | **4.20x** Â± 1.94 | 15.34% | 0 |
| 0.70 | 16.89 | **2.84x** Â± 0.15 | 61.96% | 100 |
| 0.80 | 17.52 | **2.75x** Â± 0.33 | 61.96% | 100 |
| 0.90 | 39.82 | **1.19x** Â± 0.00 | 85.28% | 275 |
| 0.95 | 43.58 | 1.11x Â± 0.10 | 95.09% | 345 |
| 1.00 | 38.47 | 1.24x Â± 0.13 | 95.09% | 345 |
| 1.01 | 56.64 | 0.84x Â± 0.08 | **100%** | 461 |

### æ¸¬è©¦æµç¨‹

```bash
# 1. ç·¨è­¯ç¨‹å¼
g++ -O2 -std=c++11 -o main_hybrid main_hybrid.cpp

# 2. åŸ·è¡Œå¤šæ¬¡æ¸¬è©¦å–å¹³å‡
python run_benchmark.py   # è‡ªå‹•åŸ·è¡Œ 3 æ¬¡ä¸¦ç”Ÿæˆå¹³å‡çµæœèˆ‡åœ–è¡¨
```

### é—œéµç™¼ç¾

| ä½¿ç”¨æƒ…å¢ƒ | å»ºè­° Threshold | åŠ é€Ÿæ¯” | æº–ç¢ºåº¦ |
|----------|----------------|--------|--------|
| è¿½æ±‚é€Ÿåº¦ | 0.5~0.6 | ~5.5x | 15% |
| **å¹³è¡¡é¸æ“‡** | **0.7~0.8** | **~2.8x** | **62%** |
| è¿½æ±‚å“è³ª | 0.9 | ~1.2x | 85% |
| å®Œå…¨æº–ç¢º | >1.0 | ~0.84xï¼ˆè®Šæ…¢ï¼‰| 100% |

> âš ï¸ **æ³¨æ„**: ç•¶ Threshold > 1.0 æ™‚ï¼Œæ‰€æœ‰æ±ºç­–éƒ½å›é€€åˆ° RDOï¼Œä½†å› ç‚º ML é æ¸¬çš„é¡å¤–é–‹éŠ·ï¼Œæ•´é«”æœƒæ¯”ç´” C Model æ…¢ç´„ 16%ã€‚

---

## ğŸ”§ æŠ€è¡“äº®é»

### 1. çœŸå¯¦çš„ RDO è¨ˆç®—
- ä½¿ç”¨ SSD è¨ˆç®—å¤±çœŸï¼Œä¸æ˜¯æ¨¡æ“¬å»¶é²
- Rate Estimation åŸºæ–¼è®Šç•°æ•¸
- ç¬¦åˆçœŸå¯¦ç·¨ç¢¼å™¨çš„æ±ºç­–é‚è¼¯

### 2. Python â†’ C++ è‡ªå‹•è½‰è­¯
```python
# Python è¨“ç·´
clf = DecisionTreeClassifier(max_depth=4)
clf.fit(X_train, y_train)

# è‡ªå‹•ç”Ÿæˆ C++ ç¨‹å¼ç¢¼
tree_to_cpp_with_confidence(clf, feature_names)
```

ç”Ÿæˆçš„ C++ ç¨‹å¼ç¢¼ï¼š
```cpp
MLPrediction predict_split_ml(double variance, double grad_h, double grad_v) {
    if (variance <= 5141.600098) {
        if (grad_h <= 62.218750) {
            return {false, 1.0000};
        } else {
            return {true, 1.0000};
        }
    }
    // ... æ›´å¤šåˆ†æ”¯
}
```

### 3. Confidence-based Fallback
- ä¸æ˜¯ã€Œå…¨ MLã€æˆ–ã€Œå…¨ RDOã€çš„äºŒé¸ä¸€
- æ ¹æ“š ML ä¿¡å¿ƒåº¦å‹•æ…‹æ±ºå®šç­–ç•¥
- å¯èª¿æ•´ Threshold æ§åˆ¶é€Ÿåº¦/å“è³ªæ¬Šè¡¡

### 4. Pareto Frontier è¦–è¦ºåŒ–
- é‡åŒ–ä¸åŒ Threshold çš„æ•ˆæœ
- å¹«åŠ©æ±ºç­–è€…é¸æ“‡æœ€é©é…ç½®
- ç¬¦åˆçœŸå¯¦ç”¢å“èª¿åƒæµç¨‹

---

## ğŸ’¡ å°ˆæ¡ˆè²¢ç»èˆ‡åƒ¹å€¼

### å°æ–¼é¢è©¦ / æŠ€è¡“å±•ç¤º

| å±•ç¤ºèƒ½åŠ› | å…·é«”å…§å®¹ |
|----------|----------|
| **C++ æ•ˆèƒ½å„ªåŒ–** | RDO è¨ˆç®—ã€è¨˜æ†¶é«”ç®¡ç†ã€ç·¨è­¯å™¨å„ªåŒ– (-O2) |
| **Python ML** | sklearn è¨“ç·´ã€æ¨¡å‹åˆ†æã€ç¨‹å¼ç¢¼ç”Ÿæˆ |
| **ç³»çµ±æ•´åˆ** | C++ â†” Python å·¥ä½œæµç¨‹è¨­è¨ˆ |
| **æ¼”ç®—æ³•è¨­è¨ˆ** | Quadtree éè¿´ã€Hybrid æ±ºç­–é‚è¼¯ |
| **è³‡æ–™åˆ†æ** | Pareto Frontierã€Trade-off åˆ†æ |
| **è¦–è¦ºåŒ–** | matplotlib åœ–è¡¨ã€çµæœå‘ˆç¾ |

### å°æ–¼å¯¦éš›æ‡‰ç”¨

1. **è¦–è¨Šç·¨ç¢¼åŠ é€Ÿ**: å¯æ•´åˆåˆ° HEVC/VVC Encoder
2. **åµŒå…¥å¼ç³»çµ±éƒ¨ç½²**: ML æ¨¡å‹ç·¨è­¯ç‚ºç´” C++ï¼Œç„¡éœ€é‹è¡Œæ™‚ä¾è³´
3. **åƒæ•¸èª¿å„ªæ¡†æ¶**: Threshold æ©Ÿåˆ¶å¯æ³›åŒ–åˆ°å…¶ä»– ML åŠ é€Ÿå ´æ™¯

---

## ğŸš€ æœªä¾†æ“´å±•æ–¹å‘

1. **å¢åŠ è¨“ç·´è³‡æ–™å¤šæ¨£æ€§**
   - ä½¿ç”¨çœŸå¯¦åœ–ç‰‡/è¦–è¨Šå¹€
   - ä¸åŒè§£æåº¦ã€ä¸åŒå…§å®¹é¡å‹

2. **å˜—è©¦æ›´è¤‡é›œçš„ ML æ¨¡å‹**
   - Random Forestï¼ˆé›†æˆå­¸ç¿’ï¼‰
   - XGBoostï¼ˆæ¢¯åº¦æå‡ï¼‰
   - è¼•é‡ç´šç¥ç¶“ç¶²è·¯

3. **å“è³ªæŒ‡æ¨™æ•´åˆ**
   - PSNR (Peak Signal-to-Noise Ratio)
   - SSIM (Structural Similarity Index)
   - BD-Rate (BjÃ¸ntegaard Delta Rate)

4. **çœŸå¯¦ç·¨ç¢¼å™¨æ•´åˆ**
   - x265 (HEVC é–‹æºå¯¦ä½œ)
   - VVenC (VVC é–‹æºå¯¦ä½œ)

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
Fast Block Partitioning/
â”œâ”€â”€ ground_truth.cpp        # Phase 1: Ground Truth ç”Ÿæˆï¼ˆåŸºæ–¼ RDO æ±ºç­–ï¼‰
â”œâ”€â”€ train_and_convert.py    # Phase 2: ML è¨“ç·´ & C++ è½‰è­¯
â”œâ”€â”€ main_hybrid.cpp         # Phase 3: Benchmark æ¸¬è©¦
â”œâ”€â”€ run_benchmark.py        # å¤šæ¬¡æ¸¬è©¦ä¸¦è¨ˆç®—å¹³å‡å€¼ï¼ˆ3 æ¬¡ï¼‰
â”œâ”€â”€ generate_image.py       # æ¸¬è©¦åœ–ç‰‡ç”Ÿæˆ
â”œâ”€â”€ plot_pareto.py          # Pareto åœ–è¡¨ç¹ªè£½
â”œâ”€â”€ visualize_partition.py  # åˆ†å‰²çµæœè¦–è¦ºåŒ–
â”œâ”€â”€ ml_model_generated.h    # è‡ªå‹•ç”Ÿæˆçš„ ML æ¨¡å‹
â”œâ”€â”€ block_data.csv          # è¨“ç·´è³‡æ–™
â”œâ”€â”€ pareto_data.csv         # å¯¦é©—çµæœï¼ˆå¹³å‡å€¼ï¼‰
â”œâ”€â”€ pareto_frontier.png     # Pareto æ›²ç·šåœ–ï¼ˆå«èª¤å·®æ£’ï¼‰
â”œâ”€â”€ partition_comparison.png # ä¸åŒ Threshold åˆ†å‰²æ¯”è¼ƒ
â”œâ”€â”€ partition_ml_vs_c.png   # ML vs C Model æ¯”è¼ƒ
â”œâ”€â”€ dummy_image.png         # æ¸¬è©¦åœ–ç‰‡
â”œâ”€â”€ dummy_image_analysis.png # æ¸¬è©¦åœ–ç‰‡åˆ†æ
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ å°ˆæ¡ˆèªªæ˜.md         # ä¸­æ–‡æŠ€è¡“æ–‡ä»¶
â””â”€â”€ README.md               # å°ˆæ¡ˆèªªæ˜ï¼ˆè‹±æ–‡ï¼‰
```

---

## ğŸ† çµè«–

> æœ¬å°ˆæ¡ˆæˆåŠŸå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ **Confidence-based Hybrid æ©Ÿåˆ¶** å°‡ ML æ¨¡å‹æ•´åˆåˆ°å‚³çµ±ç·¨ç¢¼å™¨çš„æ±ºç­–æµç¨‹ä¸­ã€‚
>
> é€éèª¿æ•´ Threshold åƒæ•¸ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ **2.4x åŠ é€Ÿ + 62% æº–ç¢ºåº¦** åˆ° **1.16x åŠ é€Ÿ + 85% æº–ç¢ºåº¦** ä¹‹é–“éˆæ´»é¸æ“‡ï¼Œé€™æ­£æ˜¯çœŸå¯¦ç”¢å“é–‹ç™¼ä¸­ Rate Control å’Œ Quality Tuning çš„æ ¸å¿ƒæ€ç¶­ã€‚

---

*å°ˆæ¡ˆé€£çµ: https://github.com/hongyan1215/Fast-block-partitioning*
